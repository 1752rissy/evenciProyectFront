<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evenci - Vende tus productos</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com " crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk :wght@400;500;700&display=swap"
    rel="stylesheet"
  />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com ?plugins=forms"></script>

  <!-- Custom Styles -->
  <style>
    body {
      font-family: "Space Grotesk", sans-serif;
      background-color: #121212;
      color: #ffffff;
    }
    .section {
      margin-bottom: 40px;
    }
    .card {
      background: #1e1e1e;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    .btn-primary {
      background: #38e07b;
      color: #121212;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .btn-primary:hover {
      background: #2fc96b;
    }
    .btn-disabled {
      background: #444444;
      cursor: not-allowed;
    }
    .input-field {
      background: #2a2a2a;
      border: 1px solid #383838;
      border-radius: 8px;
      padding: 10px;
      color: #ffffff;
      width: 100%;
    }
    .product-card {
      background: #1e1e1e;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      transition: transform 0.3s ease;
    }
    .product-card:hover {
      transform: translateY(-5px);
    }
    .product-card img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container mx-auto p-4">
    <!-- Header -->
    <header class="text-center py-6">
      <h1 class="text-3xl font-bold text-[#38E07B]">📸 Vende tus productos con inteligencia</h1>
      <p class="text-gray-400 mt-2">Desarrollado por Andrés Gutiérrez</p>
    </header>

    <!-- Sección 1: Captura de imagen -->
    <section class="section">
      <div class="card">
        <h2 class="text-xl font-semibold mb-4">1. Toma una foto de tu producto</h2>
        <video id="camera" autoplay class="w-full h-64 object-cover bg-gray-800 rounded-lg"></video>
        <img id="preview" class="hidden w-full h-64 object-cover rounded-lg mt-4" />
        <button id="capture" class="btn-primary mt-4">Capturar foto</button>
        <div id="loading-description" class="text-center text-gray-400 mt-4 hidden">Generando descripción...</div>
      </div>
    </section>

    <!-- Sección 2: Detalles del producto -->
    <section class="section" id="step2" style="display: none;">
      <div class="card">
        <h2 class="text-xl font-semibold mb-4">2. Completa los detalles</h2>
        <textarea
          id="descripcion"
          placeholder="Descripción del producto..."
          class="input-field mb-4"
          rows="4"
        ></textarea>
        <input
          id="precio"
          type="number"
          placeholder="Precio (USD)"
          class="input-field mb-4"
          min="1"
        />
        <button id="publish" class="btn-primary">Publicar Producto</button>
        <div id="loading-publish" class="text-center text-gray-400 mt-4 hidden">Publicando producto...</div>
      </div>
    </section>

    <!-- Sección 3: Muro de productos -->
    <section class="section">
      <h2 class="text-2xl font-semibold text-center mb-6">Productos Publicados</h2>
      <div class="flex justify-between items-center mb-4">
        <div class="flex gap-4">
          <select id="category-filter" class="input-field">
            <option value="">Todas las categorías</option>
          </select>
          <select id="tag-filter" class="input-field">
            <option value="">Todas las etiquetas</option>
          </select>
        </div>
        <button id="apply-filters" class="btn-primary">Aplicar Filtros</button>
      </div>
      <div id="products-container" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
    </section>
  </div>

  <!-- JavaScript -->
  <script>
    // Configuración de la API
    const API_BASE_URL = "https://envenciproject.onrender.com ";

    // Elementos del DOM
    const video = document.getElementById("camera");
    const captureBtn = document.getElementById("capture");
    const preview = document.getElementById("preview");
    const descripcion = document.getElementById("descripcion");
    const publishBtn = document.getElementById("publish");
    const loadingDescription = document.getElementById("loading-description");
    const loadingPublish = document.getElementById("loading-publish");
    const step1 = document.querySelector("#step1");
    const step2 = document.querySelector("#step2");
    const productsContainer = document.getElementById("products-container");
    const categoryFilter = document.getElementById("category-filter");
    const tagFilter = document.getElementById("tag-filter");
    const applyFiltersBtn = document.getElementById("apply-filters");

    // Estado de la aplicación
    let currentProduct = {
      image: null,
      description: null,
      price: null,
    };

    // Mostrar error
    function showError(message) {
      alert(message);
    }

    // Acceder a la cámara
    navigator.mediaDevices
      .getUserMedia({ video: true })
      .then((stream) => (video.srcObject = stream))
      .catch((err) => {
        console.error("Error al acceder a la cámara:", err);
        showError("No se pudo acceder a la cámara. Asegúrate de permitir los permisos.");
      });

    // Capturar foto
    captureBtn.addEventListener("click", async () => {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);
        currentProduct.image = canvas.toDataURL("image/jpeg");
        preview.src = currentProduct.image;
        preview.classList.remove("hidden");

        // Mostrar loading
        loadingDescription.classList.remove("hidden");
        captureBtn.disabled = true;

        // Generar descripción con la API
        const response = await fetch(`${API_BASE_URL}/api/generate-description`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: currentProduct.image }),
        });

        if (!response.ok) throw new Error("Error al generar la descripción");

        const data = await response.json();
        if (data.status === "error") throw new Error(data.error || "Error desconocido");

        currentProduct.description = data.description;
        descripcion.value = data.description;

        // Mostrar paso 2
        step1.style.display = "none";
        step2.style.display = "block";
      } catch (error) {
        console.error("Error:", error);
        showError(error.message || "Error al generar la descripción. Intenta nuevamente.");
      } finally {
        loadingDescription.classList.add("hidden");
        captureBtn.disabled = false;
      }
    });

    // Publicar producto
    publishBtn.addEventListener("click", async () => {
      try {
        const price = parseFloat(document.getElementById("precio").value);
        if (!price || price <= 0) {
          showError("Por favor ingresa un precio válido");
          return;
        }

        if (!currentProduct.description) {
          showError("Por favor genera una descripción primero");
          return;
        }

        currentProduct.price = price;

        // Mostrar loading
        loadingPublish.classList.remove("hidden");
        publishBtn.disabled = true;

        // Publicar producto con la API
        const response = await fetch(`${API_BASE_URL}/api/publish-product`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            image: currentProduct.image,
            description: currentProduct.description,
            price: currentProduct.price,
          }),
        });

        if (!response.ok) throw new Error("Error al publicar el producto");

        const data = await response.json();
        if (data.status === "error") throw new Error(data.error || "Error desconocido");

        alert("¡Producto publicado con éxito!");

        // Resetear el formulario
        preview.src = "";
        preview.classList.add("hidden");
        descripcion.value = "";
        document.getElementById("precio").value = "";
        currentProduct = { image: null, description: null, price: null };

        // Volver al paso 1
        step2.style.display = "none";
        step1.style.display = "block";

        // Recargar productos en el muro
        await loadProducts();
      } catch (error) {
        console.error("Error:", error);
        showError(error.message || "Error al publicar el producto. Intenta nuevamente.");
      } finally {
        loadingPublish.classList.add("hidden");
        publishBtn.disabled = false;
      }
    });

    // Cargar productos al iniciar la página
    async function loadProducts(category = "", tag = "") {
      try {
        let url = `${API_BASE_URL}/api/get-products`;
        const params = [];
        if (category) params.push(`category=${encodeURIComponent(category)}`);
        if (tag) params.push(`tag=${encodeURIComponent(tag)}`);
        if (params.length > 0) url += `?${params.join("&")}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error("Error al cargar los productos");

        const data = await response.json();
        if (data.status === "error") throw new Error(data.error || "Error desconocido");

        productsContainer.innerHTML = "";

        data.products.forEach((product) => {
          const productCard = document.createElement("div");
          productCard.className = "product-card";
          productCard.innerHTML = `
            <img src="${product.image}" alt="${product.description}">
            <h3 class="text-lg font-semibold mt-2">${product.description}</h3>
            <p class="text-gray-400">Precio: $${product.price.toFixed(2)}</p>
            <small class="text-gray-500">Categoría: ${product.category}</small>
            <small class="text-gray-500 block">Etiquetas: ${product.tags.join(", ")}</small>
          `;
          productsContainer.appendChild(productCard);
        });
      } catch (error) {
        console.error("Error:", error);
        showError(error.message || "Error al cargar los productos. Intenta nuevamente.");
      }
    }

    // Cargar filtros disponibles
    async function loadFilters() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/get-products`);
        if (!response.ok) throw new Error("Error al cargar los filtros");

        const data = await response.json();
        if (data.status === "error") throw new Error(data.error || "Error desconocido");

        const categories = [...new Set(data.products.map((p) => p.category))];
        const tags = [...new Set(data.products.flatMap((p) => p.tags))];

        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category;
          option.textContent = category;
          categoryFilter.appendChild(option);
        });

        tags.forEach((tag) => {
          const option = document.createElement("option");
          option.value = tag;
          option.textContent = tag;
          tagFilter.appendChild(option);
        });
      } catch (error) {
        console.error("Error:", error);
        showError(error.message || "Error al cargar los filtros. Intenta nuevamente.");
      }
    }

    // Aplicar filtros
    applyFiltersBtn.addEventListener("click", () => {
      const selectedCategory = categoryFilter.value;
      const selectedTag = tagFilter.value;
      loadProducts(selectedCategory, selectedTag);
    });

    // Cargar productos y filtros al cargar la página
    window.addEventListener("load", async () => {
      await loadProducts();
      await loadFilters();
    });
  </script>
</body>
</html>